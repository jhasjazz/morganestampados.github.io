<script>
  const form = document.getElementById("form-usuario");
  const estado = document.getElementById("estado-usuario");
  const lista = document.getElementById("lista-direcciones");
  const limiteTexto = document.createElement("p");
  limiteTexto.className = "text-center mt-2 text-sm font-medium text-red-600";
  lista.parentElement.appendChild(limiteTexto);
  let usuarioEmail = null;

  auth.onAuthStateChanged(user => {
    if (user) {
      usuarioEmail = user.email;
      cargarDirecciones();
    } else {
      alert("Por favor inicia sesiÃ³n para acceder a esta pÃ¡gina.");
      window.location.href = "index.html";
    }
  });

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    // ValidaciÃ³n manual extra por seguridad
    const nombre = document.getElementById("nombre").value.trim();
    const cedula = document.getElementById("cedula").value.trim();
    const celular = document.getElementById("celular").value.trim();
    const pais = document.getElementById("pais").value.trim();
    const departamento = document.getElementById("departamento").value.trim();
    const direccion = document.getElementById("direccion").value.trim();
    const indicaciones = document.getElementById("indicaciones").value.trim();

    if (!nombre || !cedula || !celular || !pais || !departamento || !direccion) {
      alert("Por favor llena todos los campos obligatorios.");
      return;
    }

    const snapshot = await db.collection("usuarios").doc(usuarioEmail).collection("direcciones").get();
    if (snapshot.size >= 4) {
      alert("Solo puedes tener hasta 4 direcciones guardadas.");
      return;
    }

    await db.collection("usuarios").doc(usuarioEmail).collection("direcciones").add({
      nombre, cedula, celular, pais, departamento, direccion, indicaciones, predeterminada: false
    });

    estado.classList.remove("hidden");
    form.reset();
    cargarDirecciones();
  });

  async function cargarDirecciones() {
    lista.innerHTML = "";
    const snapshot = await db.collection("usuarios").doc(usuarioEmail).collection("direcciones").get();
    const total = snapshot.size;
    let index = 1;

    snapshot.forEach(doc => {
      const data = doc.data();
      const div = document.createElement("div");
      div.className = "border p-4 rounded bg-gray-100 shadow-md flex flex-col justify-between";

      div.innerHTML = `
        <div class="mb-2">
          <h3 class="font-bold text-red-700 mb-1">DirecciÃ³n ${index}</h3>
          <p class="font-bold text-lg">${data.nombre}</p>
          <p>${data.direccion} - ${data.indicaciones || 'Sin indicaciones'}</p>
          <p>${data.pais}, ${data.departamento}</p>
          <p class="text-sm text-gray-600">ðŸ“ž ${data.celular}</p>
        </div>
        <button onclick="marcarPredeterminada('${doc.id}')" class="text-sm px-3 py-1 rounded font-semibold ${data.predeterminada ? 'bg-green-500 text-white' : 'bg-gray-300 text-black'}">
          ${data.predeterminada ? 'Predeterminada âœ“' : 'Seleccionar como predeterminada'}
        </button>
      `;
      lista.appendChild(div);
      index++;
    });

    const restantes = 4 - total;
    limiteTexto.textContent = restantes > 0
      ? `Puedes agregar ${restantes} direcciÃ³n${restantes === 1 ? '' : 'es'} mÃ¡s.`
      : 'Ya has agregado el mÃ¡ximo de 4 direcciones.';
  }

  window.marcarPredeterminada = async (id) => {
    const snapshot = await db.collection("usuarios").doc(usuarioEmail).collection("direcciones").get();
    const batch = db.batch();
    snapshot.forEach(doc => {
      const ref = doc.ref;
      batch.update(ref, { predeterminada: doc.id === id });
    });
    await batch.commit();
    cargarDirecciones();

    const direccionDoc = await db.collection("usuarios").doc(usuarioEmail).collection("direcciones").doc(id).get();
    const direccionPred = direccionDoc.data();
    localStorage.setItem("direccionPredeterminada", JSON.stringify(direccionPred));

    const event = new Event("direccionActualizada");
    window.dispatchEvent(event);
  }
</script>
